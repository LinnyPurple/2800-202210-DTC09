<!DOCTYPE html>
<html lang="en">

<head>
    <title>COMP2800 Project</title>
    <meta name="comp2800 team 9" content="My 2800 App">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap Library CSS JS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
    </script>

    <!-- Other libraries and styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

</head>

<body>
    <!-- HTML Layout -->

    <!-- top navbar -->
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-info">

        <!-- display the app logo, and direct to main.html when pressed -->
        <button type="button" class="btn nav-btn" onclick="logo_button()">
            SWAPOMEN
        </button>
    </nav>

    <!-- the body of the page -->
    <div id="content">
        <div id="TradeItem">
            <p class="TraderName"></p>
            <p class="TradeItemName"></p>
            <img class="TradeItemImg" />
        </div>
        <div id="potentialOffers">
            <template id="offerTemplate">
                <div class="offerCard">
                    <p class="OfferName"></p>
                    <img class="OfferImg" />
                    <button class="SendOffer">Send Offer</button>
                </div>
            </template>
        </div>
    </div>

    <!-- bottom navbar -->
    <nav class="navbar fixed-bottom navbar-expand-lg navbar-light bg-info">

        <!-- home button -->
        <button type="button" formaction="./index.html" class="btn nav-btn" id="homeButton">
            <i class="bi bi-house" style="font-size: 1.7rem;"></i>
        </button>

        <!-- search button -->
        <button type="button" class="btn nav-btn" id="searchButton">
            <i class="bi bi-search " style="font-size: 1.7rem;"></i>
        </button>

        <!-- upload button -->
        <button type="button" class="btn nav-btn" id="uploadButton">
            <i class="bi bi-plus-circle" style="font-size: 1.7rem;"></i>
        </button>

        <!-- upload button -->
        <button type="button" class="btn nav-btn" id="chatButton">
            <i class="bi bi-chat-left-text" style="font-size: 1.7rem;"></i>
        </button>

        <!-- profile button -->
        <button type="button" class="btn nav-btn" id="profileButton">
            <i class="bi bi-person-circle" style="font-size: 1.7rem;"></i>
        </button>
    </nav>

    <!-- JavaScript functions -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../js/template.js"></script>
    <script src="/js/webserverInterface.js"></script>
    <script src="/js/httpRequests.js"></script>
    <script>
        let listings;
        let userInfo;
        async function getPotentialOffers() {
            userInfo = JSON.parse(await getUserInfo());
            listings = JSON.parse(await getRequest('/api/getListingsFromUser/' + userInfo.uid));
            console.log(listings);

            const parent = document.querySelector("#potentialOffers");

            for (let offerInd in listings) { 
                let template = document.querySelector("#offerTemplate").content.cloneNode(true);
                let offer = listings[offerInd];

                template.querySelector(".OfferName").innerHTML = "Your: " + offer.title;
                let imgs = JSON.parse(offer.images);
                template.querySelector(".OfferImg").setAttribute('src', (imgs && imgs.length) > 0 ? imgs[0] : 'https://dummyimage.com/200x200/000/fff');
                template.querySelector(".SendOffer").setAttribute('onclick', `sendOffer(${offer.ID})`);

                parent.appendChild(template);
            }
        }

        async function sendOffer(id) {
            let offerListing = listings.find(e => e.ID == id);
            let listing = JSON.parse(await getRequest(`/api/getListingData?id=${window.location.href.split('/')[window.location.href.split('/').length - 1]}`))
            console.log(listing);
            console.log(offerListing);
            let res = await postRequest('/api/sendTradeOffer', {
                offereeID: listing.posterID,
                offererData: JSON.stringify({
                    name: offerListing.title,
                    img: (offerListing.images && JSON.parse(offerListing.images).length) > 0 ? JSON.parse(offerListing.images)[0] : 'https://dummyimage.com/200x200/000/fff'
                }),
                offereeData: JSON.stringify({
                    name: listing.title,
                    img: (listing.images && JSON.parse(listing.images).length) > 0 ? JSON.parse(listing.images)[0] : 'https://dummyimage.com/200x200/000/fff'
                })
            });
            console.log(res);
        }

        getPotentialOffers();
    </script>
</body>

</html>