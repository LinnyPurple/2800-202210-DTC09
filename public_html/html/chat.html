<!DOCTYPE html>
<html>
    <head>
        <title>SwapOmen</title>
        <link rel="stylesheet" href="/css/chat.css">
    </head>
    <body>
        <header>

        </header>
        <div id="chat">
            <template id="reciChatT">
                <div class="reciChat msg">
                    <img class="reciImg cImg" src="/img/Default_pfp.jpg" />
                    <p class="reciP cP"></p>
                </div>
            </template>
            <template id="sentChatT">
                <div class="sentChat msg">
                    <p class="sentP cP"></p>
                    <img class="sentImg cImg" src="/img/Default_pfp.jpg" />
                </div>
            </template>
        </div>
        <footer>
            <form>
                <input type="text" id="sendMessage" />
                <input type="button" id="sendButton" value="Send" />
            </form>
        </footer>
        <script src="/js/httpRequests.js"></script>
        <script src="/js/webserverInterface.js"></script>
        <script>
            let otherUser;
            let currentUser;
            let logs;
            let socket;

            async function populateChatHistory() {
                otherUser = JSON.parse(await getOtherUserInfo(window.location.href.split('/')[window.location.href.split('/').length - 1]));
                currentUser = JSON.parse(await getUserInfo());
                logs = JSON.parse(await getRequest(`/getMessageLogs/${otherUser.uid}`));
                logs = logs.sort((a, b) => (a.timestamp > b.timestamp) ? 1 : -1);

                console.log(otherUser);
                console.log(currentUser);
                console.log(logs);

                const parent = document.querySelector('#chat');
                for (let logI in logs) {
                    let log = logs[logI];

                    let template = document.querySelector((log.senderID == currentUser.uid) ? '#sentChatT' : '#reciChatT').content.cloneNode(true);
                    template.querySelector('.cImg').setAttribute('src', (log.senderID == currentUser.uid) ? (currentUser.image ? currentUser.image : '/img/Default_pfp.jpg') : (otherUser.image ? otherUser.image : '/img/Default_pfp.jpg'));
                    template.querySelector('.cP').innerHTML = log.msg;

                    parent.appendChild(template);
                }

                initWebsocket();
            }

            async function sendMessage(target, msg) {
                if (currentUser.loggedIn) {
                    socket.send(JSON.stringify({'sender': userInfo.uid, 'target': target, 'msg': msg}));
                }
                else {
                    console.log("User is not logged in.");
                }
            }

            async function initWebsocket() { 
                socket = new WebSocket(`ws://localhost:8001?uid=${encodeURIComponent(currentUser.uid)}`);

                socket.addEventListener('open', function (event) {
                    console.log("Successfully connected to websocket.");
                });

                socket.addEventListener('message', function (event) {
                    let message = JSON.parse(event.data);
                    console.log(`From ${message.sender}: `, message.msg);
                });
            }

            populateChatHistory();
        </script>
    </body>
</html>